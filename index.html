<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Интерактивная карта УрФУ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      /* Розово-фиолетовая палитра */
      --edu:        #6a4cff;  /* учебные корпуса */
      --sport:      #ff5fb3;  /* спортивные корпуса */
      --stops:      #b08cff;  /* остановки/транспорт */
      --places:     #ff92d0;  /* интересные места */

      --bg-a: #ffd3f1;
      --bg-b: #d9d0ff;
      --bg-c: #9c8cff;

      --text: #231942;
      --muted:#5e4bb5;

      --card: rgba(255,255,255,.86);
      --stroke: rgba(35,25,66,.10);
      --shadow: 0 18px 45px rgba(60,30,140,.22);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 550px at 15% 10%, rgba(255,100,190,.28), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(120,90,255,.25), transparent 55%),
        linear-gradient(135deg, var(--bg-a), var(--bg-b), var(--bg-c));
      min-height: 100vh;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px 28px;
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }

    .hero{
      background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.80));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      flex: 1 1 560px;
      min-width: 320px;
    }

    .hero h1{
      margin:0 0 6px;
      font-size: 24px;
      letter-spacing: .2px;
    }

    .hero p{
      margin:0;
      color: var(--muted);
      font-size: 14.5px;
      line-height: 1.35;
      max-width: 860px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
      align-items:flex-start;
      flex: 0 1 360px;
    }

    .chip{
      background: rgba(255,255,255,.65);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 8px 10px;
      box-shadow: 0 8px 18px rgba(60,30,140,.10);
      font-size: 12.5px;
      color: var(--muted);
      white-space: nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.55fr .85fr;
      gap: 14px;
      align-items:start;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(255,255,255,.55);
    }

    .card-hd .ttl{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      letter-spacing:.2px;
    }

    #map{
      width: 100%;
      height: min(74vh, 780px);
    }

    .panel{
      padding: 14px 14px 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .section-title{
      margin: 0;
      font-size: 13px;
      color: var(--muted);
      letter-spacing:.2px;
    }

    .btnrow{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
    }

    .btn{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.65);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text);
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(60,30,140,.10);
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.80); }
    .btn:active{ transform: translateY(1px); }

    .legend{
      display:flex;
      flex-direction:column;
      gap: 10px;
      font-size: 14px;
    }

    .legend-item{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(255,255,255,.55);
    }

    .dot{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.25);
      flex: 0 0 auto;
    }

    .legend-text{
      display:flex;
      flex-direction:column;
      gap: 2px;
      line-height:1.2;
    }
    .legend-text b{ font-size: 13.5px; }
    .legend-text span{ font-size: 12px; color: var(--muted); }

    .hint{
      padding: 10px 10px;
      border: 1px dashed rgba(35,25,66,.20);
      border-radius: 14px;
      background: rgba(255,255,255,.50);
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }

    footer{
      margin-top: 14px;
      text-align:center;
      color: rgba(35,25,66,.70);
      font-size: 12px;
    }

    /* Leaflet cosmetics */
    .leaflet-control-layers{
      border-radius: 14px !important;
      overflow:hidden;
      box-shadow: 0 14px 30px rgba(60,30,140,.16) !important;
    }
    .leaflet-popup-content-wrapper{
      border-radius: 14px !important;
    }
    .leaflet-popup-content{
      margin: 12px 12px 10px !important;
      font-size: 13px;
      line-height: 1.25;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="hero">
        <h1>Интерактивная карта объектов УрФУ</h1>
        <p>
          Карта учебных и спортивных корпусов (и сопутствующих точек) для города Екатеринбурга.
          Данные подготовлены в QGIS и экспортированы в GeoJSON, визуализация выполнена на Leaflet.
        </p>
      </div>

      <div class="chips">
        <div class="chip">QGIS → GeoJSON</div>
        <div class="chip">Leaflet + OpenStreetMap</div>
        <div class="chip">Публичная ссылка (GitHub Pages)</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-hd">
          <p class="ttl">Карта</p>
          <div class="btnrow">
            <button class="btn" id="btnFit">Показать всё</button>
            <button class="btn" id="btnEdu">Только учебные</button>
            <button class="btn" id="btnSport">Только спортивные</button>
          </div>
        </div>
        <div id="map"></div>
      </div>

      <div class="card">
        <div class="card-hd">
          <p class="ttl">Легенда и управление</p>
        </div>

        <div class="panel">
          <div class="legend">
            <div class="legend-item">
              <span class="dot" style="background: var(--edu);"></span>
              <div class="legend-text">
                <b>Учебные корпуса УрФУ</b>
                <span>единый цвет для всех учебных зданий</span>
              </div>
            </div>

            <div class="legend-item">
              <span class="dot" style="background: var(--sport);"></span>
              <div class="legend-text">
                <b>Спортивные корпуса УрФУ</b>
                <span>отдельный цвет для спортивных корпусов</span>
              </div>
            </div>

            <div class="legend-item">
              <span class="dot" style="background: var(--stops);"></span>
              <div class="legend-text">
                <b>Остановки / транспорт</b>
                <span>доп. слой для ориентации</span>
              </div>
            </div>

            <div class="legend-item">
              <span class="dot" style="background: var(--places);"></span>
              <div class="legend-text">
                <b>Интересные места</b>
                <span>точки притяжения рядом с объектами</span>
              </div>
            </div>
          </div>

          <div class="hint">
            <b>Как пользоваться:</b><br>
            • Колесо мыши — масштаб<br>
            • Перетаскивание — перемещение<br>
            • Клик по точке — только название объекта (без лишнего)<br>
            • Переключатель слоёв — справа сверху на карте
          </div>
        </div>
      </div>
    </div>

    <footer>
      Учебный проект · «Технологии презентации и визуализации контента» · УрФУ · Екатеринбург
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Берём цвета из CSS-переменных (так надёжнее)
    function cssVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    const COLORS = {
      edu: cssVar('--edu'),
      sport: cssVar('--sport'),
      stops: cssVar('--stops'),
      places: cssVar('--places'),
    };

    // 1) Карта (Екатеринбург)
    const map = L.map('map').setView([56.8389, 60.6057], 12);

    // 2) Подложка (без ключей)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // 3) ТОЛЬКО НАЗВАНИЕ: пытаемся найти name/Название/title
    function getName(props){
      if (!props) return 'Без названия';
      const candidates = [
        props.name, props.Name, props.title, props.Title,
        props['Название'], props['название'],
        props['Наименование'], props['наименование']
      ];
      for (const v of candidates){
        if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim();
      }
      return 'Без названия';
    }

    // 4) Загрузка слоя
    function loadLayer(file, color, label){
      return fetch(file, { cache: 'no-store' })
        .then(r => {
          if (!r.ok) throw new Error(`${file}: HTTP ${r.status}`);
          return r.json();
        })
        .then(data => {
          const layer = L.geoJSON(data, {
            pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
              radius: 6,
              fillColor: color,
              color: 'rgba(0,0,0,.55)',
              weight: 1,
              fillOpacity: 0.92
            }),
            onEachFeature: (feature, lyr) => {
              const name = getName(feature.properties);
              lyr.bindPopup(`<b>${name}</b>`);
            }
          });
          return { label, layer };
        });
    }

    // 5) Подключаем 4 слоя
    const layersState = {
      edu: null,
      sport: null,
      stops: null,
      places: null,
      bounds: null
    };

    Promise.all([
      loadLayer('education.geojson', COLORS.edu, 'Учебные корпуса УрФУ'),
      loadLayer('sports.geojson', COLORS.sport, 'Спортивные корпуса УрФУ'),
      loadLayer('stops.geojson', COLORS.stops, 'Остановки / транспорт'),
      loadLayer('interesting_places.geojson', COLORS.places, 'Интересные места')
    ]).then(([edu, sport, stops, places]) => {
      layersState.edu = edu.layer.addTo(map);
      layersState.sport = sport.layer.addTo(map);
      layersState.stops = stops.layer.addTo(map);
      layersState.places = places.layer.addTo(map);

      const overlays = {};
      overlays[edu.label] = layersState.edu;
      overlays[sport.label] = layersState.sport;
      overlays[stops.label] = layersState.stops;
      overlays[places.label] = layersState.places;

      // Переключатель слоёв (классно для защиты)
      L.control.layers(null, overlays, { collapsed: true }).addTo(map);

      // Общий bounds
      const all = [layersState.edu, layersState.sport, layersState.stops, layersState.places]
        .map(l => l.getBounds())
        .filter(b => b && b.isValid());

      if (all.length){
        const merged = all.reduce((acc, b) => acc.extend(b), all[0]);
        layersState.bounds = merged;
        map.fitBounds(merged, { padding: [22,22] });
      }

      // Кнопки управления
      document.getElementById('btnFit').addEventListener('click', () => {
        if (layersState.bounds?.isValid()) map.fitBounds(layersState.bounds, { padding:[22,22] });
      });

      document.getElementById('btnEdu').addEventListener('click', () => {
        showOnly(['edu']);
      });

      document.getElementById('btnSport').addEventListener('click', () => {
        showOnly(['sport']);
      });

      function showOnly(keys){
        const allKeys = ['edu','sport','stops','places'];
        for (const k of allKeys){
          const layer = layersState[k];
          if (!layer) continue;
          if (keys.includes(k)){
            if (!map.hasLayer(layer)) layer.addTo(map);
          } else {
            if (map.hasLayer(layer)) map.removeLayer(layer);
          }
        }
        // fit по видимым слоям
        const visibleBounds = allKeys
          .filter(k => layersState[k] && map.hasLayer(layersState[k]))
          .map(k => layersState[k].getBounds())
          .filter(b => b && b.isValid());

        if (visibleBounds.length){
          const merged = visibleBounds.reduce((acc,b)=>acc.extend(b), visibleBounds[0]);
          map.fitBounds(merged, { padding:[22,22] });
        }
      }
    }).catch(err => {
      console.error(err);
      alert('Ошибка загрузки слоёв. Проверь, что файлы .geojson лежат рядом с index.html и экспортированы в EPSG:4326.');
    });
  </script>
</body>
</html>
